Name of Casestudy : <%= @casestudy.tile %>
Duration of Casestudy <%= @casestudy.duration %>
Scale : <%= @casestudy.scale %>

<div id="timer"></div>

<%= @time_remaining %>

<% @casestudy.pages.each do |p| %>

<%= p.body %>

<% end %>
<br>
<% @casestudy.questions.each do |q| %>
<br>
<td>
    <%= q.tile %>
    <%= render "user_responses/response_form", response: q.user_responses.find_by(user_id: current_user.id) %>
<td>
<% end %>

<%= link_to 'Submit answers', final_submit_path(@casestudy_user) %>

<script>
    const current_path = window.location.pathname

    duration = <%= @duration  %> * 60
    console.log(duration)
    timeRemaining = duration - <%= @casestudy_user.time_elapsed %> //new Date("<%= @time_remaining %>");
    console.log(timeRemaining);
    cd_timer  = setInterval(updateTimer, 1000)
    update_db = setInterval(updateDB, 5000)
    
    function updateDB() {
            if(current_path != location.pathname) {
                clearInterval(cd_timer);
                clearInterval(update_db);
                return;
            }
                const request = new XMLHttpRequest();
                console.log(request)
                request.open("post", "<%= update_time_path(@casestudy_user) %>");
                const token = document.querySelector('meta[name="csrf-token"]').content;
                request.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
                request.setRequestHeader("X-CSRF-Token", token);
                request.send(`time_elapsed=${5}`);
            
    //         if (t.total <= 0){
    //             clearInterval(timeinterval);

    //             const request = new XMLHttpRequest();
    //             request.open("post", "<%= final_submit_path %>");
    //             const token = document.querySelector('meta[name="csrf-token"]').content;
    //             request.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
    //             request.setRequestHeader("X-CSRF-Token", token);
    //             request.send();
    }

    function updateTimer(){
         if(current_path != location.pathname) {
                clearInterval(cd_timer);
                clearInterval(update_db);
                return;
        }

        timeRemaining = timeRemaining - 1;
        console.log(timeRemaining)
        timer.innerHTML = timeRemaining;

        if(timeRemaining <= 0 ){
            clearInterval(cd_timer);
            clearInterval(update_db);

                const request = new XMLHttpRequest();
                request.open("get", "<%= final_submit_path %>");
                const token = document.querySelector('meta[name="csrf-token"]').content;
                request.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
                request.setRequestHeader("X-CSRF-Token", token);
                request.send();

        }
    }
    
    
//     function getTimeRemaining(endtime){
//         const total = Date.parse(endtime) - Date.parse(new Date());
//         const seconds = Math.floor( (total/1000) % 60 );
//         const minutes = Math.floor( (total/1000/60) % 60 );
//         const hours = Math.floor( (total/(1000*60*60)) % 24 );
//         const days = Math.floor( total/(1000*60*60*24) );

//         return {
//             total,
//             days,
//             hours,
//             minutes,
//             seconds
//         };
//     }


//     function initializeClock(id, endtime){
//         const clock = document.getElementById(id);
//         const timeinterval = setInterval(() => {
//             const t = getTimeRemaining(endtime);
//             clock.innerHTML = t.days + ' days :' + t.hours + ' hours :' t.minutes + ' minutes :' + t.seconds + ' seconds';
//             if (t.seconds % 30 === 0){
//                 const request = new XMLHttpRequest();
//                 request.open("post", "<%= update_time_path(@casestudy_user) %>");
//                 const token = document.querySelector('meta[name="csrf-token"]').content;
//                 request.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
//                 request.setRequestHeader("X-CSRF-Token", token);
//                 request.send(`time_elapsed=${t.total}`);
//             }
//             if (t.total <= 0){
//                 clearInterval(timeinterval);

//                 const request = new XMLHttpRequest();
//                 request.open("post", "<%= final_submit_path %>");
//                 const token = document.querySelector('meta[name="csrf-token"]').content;
//                 request.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
//                 request.setRequestHeader("X-CSRF-Token", token);
//                 request.send();
//             }
//         }, 1000);
//     }
// initializeClock('timer', timeRemaining);
</script>
